name: Publish Ansible Collection

on:
  push:
    tags:
      - "*"  # Triggers when a tag like v1.0.0 is pushed

permissions:
  contents: write
  actions: read  # Ensure workflow status can be read

jobs:
  verify_tests:
    name: Verify Test Results
    runs-on: ubuntu-latest

    steps:
      - name: Check Last CI Workflow Status
        id: check-tests
        run: |
          response=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                           -H "Accept: application/vnd.github.v3+json" \
                           "https://api.github.com/repos/${{ github.repository }}/actions/workflows/ansible-test.yml/runs?branch=main&status=completed")
          
          latest_status=$(echo "$response" | jq -r '.workflow_runs[0].conclusion')

          echo "Latest test run status: $latest_status"

          if [[ "$latest_status" != "success" ]]; then
            echo "‚ùå Tests failed or not completed. Skipping publish."
            exit 1
          fi

  publish:
    name: Publish Collection
    needs: verify_tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Collection Artifact
        uses: actions/download-artifact@v4
        with:
          name: collection-tarball
          path: dist/

      - name: Install Ansible Galaxy CLI
        run: pip install ansible-core

      - name: Publish to Ansible Galaxy
        run: ansible-galaxy collection publish dist/*.tar.gz --api-key ${{ secrets.ANSIBLE_GALAXY_API_KEY }}
