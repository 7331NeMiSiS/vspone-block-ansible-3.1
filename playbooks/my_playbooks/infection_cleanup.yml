---
- name: Cleanup files created by random file playbook
  hosts: localhost
  gather_facts: no
  connection: local

  vars:
    vcenter_host: "vcenter.example.com"
    vcenter_user: "administrator@vsphere.local"
    vcenter_password: "VcenterPassword"
    vm_display_names:
      - "Windows-Target-VM-1"
      - "Windows-Target-VM-2"
      - "Windows-Target-VM-3"
    
    windows_user: "Administrator"
    windows_password: "YourPasswordHere"
    windows_port: 5985

    file_names:
      - "svchost.exe"
      - "autoexec.bat"
      - "config.sys"
      - "questionaire.dll"
      - "newDriverExtention.dll"
      - "TheRocket.exe"
      - "Elevator.exe"
      - "RootKit.exe"
      - "DontTheKat.exe"
    target_directories:
      - "c:\\script"
      - "c:\\Users\\Administrator"
      - "c:\\Program Files"
      - "e:\\Script"
      - "e:\\temp"
      - "e:\\Shared"
      - "e:\\Install"
      - "e:\\Deployed"

  tasks:
    - name: Get vCenter session token
      uri:
        url: "https://{{ vcenter_host }}/api/session"
        method: POST
        user: "{{ vcenter_user }}"
        password: "{{ vcenter_password }}"
        force_basic_auth: yes
        validate_certs: no
        status_code: 201
      register: vcenter_session

    - name: Get list of VMs
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/vm"
        method: GET
        headers:
          vmware-api-session-id: "{{ vcenter_session.json }}"
        validate_certs: no
        status_code: 200
      register: vm_list

    - name: Find target VMs by display names
      set_fact:
        target_vms: "{{ vm_list.json | selectattr('name', 'in', vm_display_names) | list }}"

    - name: Get VM network info for all targets
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/vm/{{ item.vm }}/guest/networking/interfaces"
        method: GET
        headers:
          vmware-api-session-id: "{{ vcenter_session.json }}"
        validate_certs: no
        status_code: 200
      loop: "{{ target_vms }}"
      register: vm_network_results

    - name: Build VM to IP mapping
      set_fact:
        vm_ip_map: "{{ vm_ip_map | default({}) | combine({item.item.name: (item.json | map(attribute='ip.ip_addresses') | flatten | selectattr('ip_address', 'match', '^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$') | map(attribute='ip_address') | first)}) }}"
      loop: "{{ vm_network_results.results }}"

    - name: Display target VMs and IPs
      debug:
        msg: "Found {{ vm_ip_map | length }} VMs - {{ vm_ip_map }}"

    - name: Check and remove files from all locations
      ansible.windows.win_powershell:
        script: |
          $fileNames = @("{{ file_names | join('", "') }}")
          $targetDirectories = @("{{ target_directories | join('", "') }}")
          
          $filesFound = 0
          $filesDeleted = 0
          
          foreach ($directory in $targetDirectories) {
              if (Test-Path -Path $directory) {
                  foreach ($fileName in $fileNames) {
                      $filePath = Join-Path -Path $directory -ChildPath $fileName
                      
                      if (Test-Path -Path $filePath) {
                          $filesFound++
                          Write-Output "Found: $filePath"
                          
                          try {
                              Remove-Item -Path $filePath -Force -ErrorAction Stop
                              $filesDeleted++
                              Write-Output "Deleted: $filePath"
                          } catch {
                              Write-Output "Error deleting: $filePath - $($_.Exception.Message)"
                          }
                      }
                  }
              }
          }
          
          Write-Output "Summary: Found $filesFound files, Deleted $filesDeleted files"
      delegate_to: "{{ item.value }}"
      vars:
        ansible_connection: winrm
        ansible_user: "{{ windows_user }}"
        ansible_password: "{{ windows_password }}"
        ansible_port: "{{ windows_port }}"
        ansible_winrm_transport: ntlm
        ansible_winrm_server_cert_validation: ignore
      loop: "{{ vm_ip_map | dict2items }}"
      register: cleanup_result
      ignore_errors: yes

    - name: Display cleanup results
      debug:
        msg: "VM: {{ item.item.key }} ({{ item.item.value }}) - {{ item.output }}"
      loop: "{{ cleanup_result.results }}"
