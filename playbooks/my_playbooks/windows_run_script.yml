---
- name: Execute PowerShell script on Windows host
  hosts: localhost
  gather_facts: no
  connection: local
  
  vars:
    vcenter_host: "vcenter.example.com"
    vcenter_user: "administrator@vsphere.local"
    vcenter_password: "VcenterPassword"
    vm_display_names:
      - "Windows-Target-VM-1"
      - "Windows-Target-VM-2"
      - "Windows-Target-VM-3"
    
    windows_user: "Administrator"
    windows_password: "YourPasswordHere"
    windows_port: 5985
    
    script_path: "c:\\scripts\\ransomware-enable.ps1"

    needs_restart: yes
    restart_timeout: 600
    restart_message: "System restart required after script execution"
  
  tasks:
    - name: Get vCenter session token
      uri:
        url: "https://{{ vcenter_host }}/api/session"
        method: POST
        user: "{{ vcenter_user }}"
        password: "{{ vcenter_password }}"
        force_basic_auth: yes
        validate_certs: no
        status_code: 201
      register: vcenter_session

    - name: Get list of VMs
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/vm"
        method: GET
        headers:
          vmware-api-session-id: "{{ vcenter_session.json }}"
        validate_certs: no
        status_code: 200
      register: vm_list

    - name: Find target VMs by display names
      set_fact:
        target_vms: "{{ vm_list.json | selectattr('name', 'in', vm_display_names) | list }}"

    - name: Get VM network info for all targets
      uri:
        url: "https://{{ vcenter_host }}/api/vcenter/vm/{{ item.vm }}/guest/networking/interfaces"
        method: GET
        headers:
          vmware-api-session-id: "{{ vcenter_session.json }}"
        validate_certs: no
        status_code: 200
      loop: "{{ target_vms }}"
      register: vm_network_results

    - name: Build VM to IP mapping
      set_fact:
        vm_ip_map: "{{ vm_ip_map | default({}) | combine({item.item.name: (item.json | map(attribute='ip.ip_addresses') | flatten | selectattr('ip_address', 'match', '^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$') | map(attribute='ip_address') | first)}) }}"
      loop: "{{ vm_network_results.results }}"

    - name: Display target VMs and IPs
      debug:
        msg: "Found {{ vm_ip_map | length }} VMs - {{ vm_ip_map }}"

    - name: Check if PowerShell script exists
      ansible.windows.win_stat:
        path: "{{ script_path }}"
      delegate_to: "{{ item.value }}"
      vars:
        ansible_connection: winrm
        ansible_user: "{{ windows_user }}"
        ansible_password: "{{ windows_password }}"
        ansible_port: "{{ windows_port }}"
        ansible_winrm_transport: ntlm
        ansible_winrm_server_cert_validation: ignore
      loop: "{{ vm_ip_map | dict2items }}"
      register: script_file
    
    - name: Display script information
      debug:
        msg: 
          - "VM: {{ item.item.key }} ({{ item.item.value }})"
          - "Script found: {{ script_path }}"
          - "Size: {{ item.stat.size }} bytes"
          - "Last modified: {{ item.stat.lastwritetime }}"
      loop: "{{ script_file.results }}"
      when: item.stat.exists
    
    - name: Execute PowerShell script
      ansible.windows.win_shell: |
        & "{{ script_path }}"
      delegate_to: "{{ item.value }}"
      vars:
        ansible_connection: winrm
        ansible_user: "{{ windows_user }}"
        ansible_password: "{{ windows_password }}"
        ansible_port: "{{ windows_port }}"
        ansible_winrm_transport: ntlm
        ansible_winrm_server_cert_validation: ignore
      loop: "{{ vm_ip_map | dict2items }}"
      register: script_output

    - name: Force restart Windows host (if needed)
      ansible.windows.win_reboot:
        reboot_timeout: "{{ restart_timeout }}"
        msg: "{{ restart_message }}"
        pre_reboot_delay: 10
        post_reboot_delay: 45
      delegate_to: "{{ item.value }}"
      vars:
        ansible_connection: winrm
        ansible_user: "{{ windows_user }}"
        ansible_password: "{{ windows_password }}"
        ansible_port: "{{ windows_port }}"
        ansible_winrm_transport: ntlm
        ansible_winrm_server_cert_validation: ignore
      loop: "{{ vm_ip_map | dict2items }}"
      register: reboot_result
      when: needs_restart | bool
    
    - name: Display script execution results
      debug:
        msg:
          - "VM: {{ item.item.key }} ({{ item.item.value }})"
          - "Script executed successfully"
          - "Exit Code: {{ item.rc }}"
          - "--- Output ---"
          - "{{ item.stdout }}"
      loop: "{{ script_output.results }}"
    
    - name: Display any errors
      debug:
        msg:
          - "VM: {{ item.item.key }} ({{ item.item.value }})"
          - "--- Errors/Warnings ---"
          - "{{ item.stderr }}"
      loop: "{{ script_output.results }}"
      when: item.stderr | length > 0
