---
- name: Execute PowerShell script on Windows host
  hosts: localhost
  gather_facts: no
  connection: local
  
  vars:
    # Windows host connection details
    windows_host: "192.168.1.100"
    windows_user: "Administrator"
    windows_password: "YourPasswordHere"
    windows_port: 5985  # Use 5985 for HTTP, 5986 for HTTPS
    
    # Script details
    script_path: "c:\\scripts\\ransomware-enable.ps1"
  
  tasks:
    - name: Check if PowerShell script exists
      ansible.windows.win_stat:
        path: "{{ script_path }}"
      delegate_to: "{{ windows_host }}"
      vars:
        ansible_connection: winrm
        ansible_user: "{{ windows_user }}"
        ansible_password: "{{ windows_password }}"
        ansible_port: "{{ windows_port }}"
        ansible_winrm_transport: ntlm
        ansible_winrm_server_cert_validation: ignore
      register: script_file
    
    - name: Fail if script does not exist
      fail:
        msg: "Script not found at {{ script_path }}"
      when: not script_file.stat.exists
    
    - name: Display script information
      debug:
        msg: 
          - "Script found: {{ script_path }}"
          - "Size: {{ script_file.stat.size }} bytes"
          - "Last modified: {{ script_file.stat.lastwritetime }}"
      when: script_file.stat.exists
    
    - name: Execute PowerShell script
      ansible.windows.win_shell: |
        & "{{ script_path }}"
      delegate_to: "{{ windows_host }}"
      vars:
        ansible_connection: winrm
        ansible_user: "{{ windows_user }}"
        ansible_password: "{{ windows_password }}"
        ansible_port: "{{ windows_port }}"
        ansible_winrm_transport: ntlm
        ansible_winrm_server_cert_validation: ignore
      register: script_output
    
    - name: Display script execution results
      debug:
        msg:
          - "Script executed successfully"
          - "Exit Code: {{ script_output.rc }}"
          - "--- Output ---"
          - "{{ script_output.stdout }}"
    
    - name: Display any errors
      debug:
        msg:
          - "--- Errors/Warnings ---"
          - "{{ script_output.stderr }}"
      when: script_output.stderr | length > 0
